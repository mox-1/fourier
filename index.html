<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <style>
      .axis {
        stroke: hsl(0, 0%, 70%);
      }

      .freq-axis, .freq-axis path, .tick line {
        stroke: steelblue;
      }

      .bar-chart {
        opacity: 0.1;
      }

      .line {
        fill: none;
        stroke: steelblue;
        stroke-width: 1.5px;
      }
      .new.line {
        stroke: pink;
      }

      .bar {
        cursor: pointer;
      }

      .bar.disabled {
        cursor: default;
      }

      .bar.disabled:hover {
        fill: white;
      }

      .bar:hover {
        fill: steelblue;
      }

  </style>
</head>
<body>
    <input id="zoom" type="range" value="1" min="0.1" max="1" step="0.01"> <label>Time zoom</label>
    <script src="https://d3js.org/d3.v4.min.js"></script>
<script>
    var
        margin = {top: 40, right: 0, bottom: 40, left: 50},
        W = 960,
        H = 500,
        w = W - margin.left - margin.right,
        h = H - margin.top - margin.bottom,
        π = Math.PI,
        periods = 4,
        MAX_FREQ = 10,
        MERGE_DURATION = 800,
        resolution = 2 * MAX_FREQ,
        harmonics = [],
        mainData = createData(harmonics),
        zoom = d3.select('#zoom'),
        sliderValue = 1,
        addHarmonicDisabled = false;

    var xScale = d3.scaleLinear()
        .domain([0, 2 * π * periods])
        .range([0, w]),
    yScale = d3.scaleLinear()
        .domain([-10, 10])
        .range([0, h]),
    pixelToAmplitude = d3.scaleLinear()
        .domain([0, h])
        .range([1, 0]);
    line = d3.line()
        .x(function(d) {
            return xScale(d.x);
        })
        .y(function(d) {
            return yScale(d.y);
        })
        .curve(d3.curveNatural),
    freqAxis = d3.axisTop(xScale.copy().domain([0, 1]));
    createData(harmonics);

    var svg = d3.select("body")
        .append("svg")
            .attr("width", W)
            .attr("height", H),
        g = svg.append("g")
            .attr('class', 'main')
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")"),
        barChart = svg.append("g")
            .attr('class', 'bar-chart')
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")"),
        mainPath = g.append("path")
            .attr("class", "line");

    g.append("line")
        .attr("class", "axis")
        .attr("x1", 0).attr("y1", 0)
        .attr("x2", 0).attr("y2", h);

    g.append('g')
        .attr('class', 'freq-axis')
        .call(freqAxis)

    function drawMainPath() {
        mainPath.data([mainData])
            .transition()
            .duration(MERGE_DURATION)
            .attr("d", line)
            .on('end', function() {
                d3.select('.line.new').remove();
                addHarmonicDisabled = false;
                zoom.attr('disabled', null);
                d3.selectAll('.bar')
                    .classed('disabled', false);
            });
    }

    function addHarmonic(freq, amp) {
        // lets set freq in kHz, so that scale peaks at 1ms
        // 2π === 1ms
        // plan: add new path, transition to combined data from both sides
        var existingHarmonic;
        if (harmonics.some(function(obj) {
            if (obj.frequency === freq) {
                existingHarmonic = obj;
                return true;
            }
            return false;
        })) {
            harmonics = harmonics.filter(function(obj) {
                return obj.frequency !== freq;
            });
            mainData = createData(harmonics);
            mainPath.data([mainData])
                .transition()
                .duration(200)
                .attr("d", line)
        }
        function mergeNewCurveWithMain() {
            newCurve
                .data([mainData])
                .transition()
                .duration(MERGE_DURATION)
                .attr("d", line);
        }
        var harmonic = function(d) {
            return (amp || 1) * Math.sin(d * freq);
        };
        harmonic.frequency = freq;
        var newCurve = g.append('path');
        addHarmonicDisabled = true;
        zoom.attr('disabled', true);
        d3.selectAll('.bar')
            .classed('disabled', true);
        newCurve.data([createData([existingHarmonic] || [])])
            .attr('class', 'line new')
            .attr("d", line);

        newCurve
            .data([createData([harmonic])])
            .transition()
            .duration(2000)
            .attr("d", line)
            .on('end', function() {
                harmonics.push(harmonic);
                mainData = createData(harmonics);
                drawMainPath();
                mergeNewCurveWithMain();
            });
    }

    function createData(harmonics) {
        return d3.range(0, (2 * π) * periods + (π / resolution), (π / resolution)).map(function(d, i) {
            return {
                x: d,
                y: harmonics.reduce(function(a, b) {
                    if (typeof b === 'function') {
                        return a + b(d)
                    } else {
                        return a;
                    }
                }, 0)
            }
        });
    }

    function setScale(val, click) {
        xScale.domain([0, val * (2 * π) * periods]);
        freqAxis = d3.axisTop(xScale.copy()
            .domain([0, val]));
        var t = g.transition().duration(click ? 750 : 0);
        t.select(".freq-axis")
            .call(freqAxis)
        if(click) {
            d3.selectAll('.line')
                .transition()
                .duration(750)
                .attr('d', line)
        } else {
            d3.selectAll('.line')
                .attr('d', line)
        }
    }

    zoom.on('input', function() {
        if (Math.abs(this.value - sliderValue) > 0.2) {
            setScale(+this.value, true);
        } else {
            setScale(+this.value, false);
        }
        sliderValue = this.value;
    });

    var barData = d3.range(0, 10).map(function(d) {
        return h;
    });

    var bars = barChart.selectAll('rect')
        .data(barData)
        .enter().append("g")
        .attr('class', 'bar')
        .attr('id', function(d, i) {
            return i + 1;
        })
        .attr("transform", function(d, i) { return "translate(" + i * w/10 + "," + 0 + ")"; })
        .on('click', function() {
            if (!addHarmonicDisabled) {
                var selection = d3.select(this).datum(d3.mouse(this)[1]);
                addHarmonic(this.id, pixelToAmplitude(d3.select(this).data()));
                selection.select('.bar.inner')
                    .transition()
                    .duration(MERGE_DURATION)
                    .attr('height', function(d, i) {
                        return h - d;
                    })
                    .attr('y', function(d, i) {
                        return d;
                    })
            }
        });
    bars.append("rect")
        .attr('class', 'bar')
        .attr("width", w/10)
        .attr("height", h)
        .attr('fill', 'white')
        .attr('id', function(d, i) {
            return i;
    })
    bars.append('rect')
        .attr('class', 'bar inner')
        .attr("width", w/10)
        .attr('height', function(d, i) {
            return h - d;
        })
        .attr('y', function(d, i) {
            return d;
        })
        .attr('fill', 'pink');



    drawMainPath();

</script>
</body>